

# 1) save your Docker image to a tar
docker save runner:dev -o runner_hmc.tar

# 2) convert tar â†’ SIF
apptainer build runner_hmc.sif docker-archive://runner_hmc.tar


# 3a) give the right permission to results fgolder
	
	# results folder
	OUT="/home/fabio/Desktop/shybox/dset/case_study_destine/results"

	# make sure the dir exists
	mkdir -p "$OUT"

	# take ownership and grant sane perms
	sudo chown -R "$USER":"$USER" "$OUT"
	chmod -R u+rwX,g+rwX,o+rX "$OUT"

	# remove 'immutable' flag if it was set (rare but nasty)
	sudo chattr -R -i "$OUT"

	# verify you can write now
	touch "$OUT/.perm_test" && echo "OK" || echo "FAIL"

# 3b) run apptainer using configuration and volume(s)
apptainer run \
  --writable-tmpfs \
  --env TIME_RUN="2021-11-26 00:00" \
  --env TIME_RESTART="2021-11-25 23:00" \
  --env TIME_PERIOD=5 \
  --env DOMAIN_NAME="marche" \
  --env APP_CONFIG="/app/execution/app_runner_workflow_hmc_marche.json" \
  --env-file app_entrypoint.env \
  --bind /home/fabio/Desktop/shybox/docker/app_runner_workflow_hmc_marche.json:/app/execution/app_runner_workflow_hmc_marche.json \
  --bind /home/fabio/Desktop/shybox/dset/case_study_destine/data/:/app/mnt_in \
  --bind /home/fabio/Desktop/shybox/dset/case_study_destine/results/:/app/mnt_out \
  runner_hmc.sif
 
# 3c) exec apptainer command
apptainer exec \
  --env TIME_RUN="2021-11-26 00:00" \
  --env TIME_RESTART="2021-11-25 23:00" \
  --env TIME_PERIOD=5 \
  --env DOMAIN_NAME="marche" \
  --env APP_CONFIG="/app/execution/app_runner_workflow_hmc_marche.json" \
  --env-file app_entrypoint.env \
  --bind /home/fabio/Desktop/shybox/docker/app_runner_workflow_hmc_marche.json:/app/execution/app_runner_workflow_hmc_marche.json \
  --bind /home/fabio/Desktop/shybox/dset/case_study_destine/data/:/app/mnt_in \
  --bind /home/fabio/Desktop/shybox/dset/case_study_destine/results/:/app/mnt_out \
  runner_hmc.sif \
  python app_entrypoint.py
  
# 3d) run aptainer interactive shell
apptainer shell runner_hmc.sif
